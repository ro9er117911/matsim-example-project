# MATSim捷運代理人使用walk模式問題診斷指南

**118名代理人設計使用捷運卻全部walking：配置錯誤導致PT路由完全失效。** 當MATSim中所有PT Transfer Agent都退回到walk模式（從第0次到第5次迭代walk_travel都是118，pt travel為0），這表示公共運輸路由器根本無法找到有效的PT路線。基於您的台北捷運場景（包含綠線、橘線、紅線、棕線的轉乘行程），問題幾乎可以確定源於三個核心配置錯誤之一：network.xml中的link modes設定、config.xml的transit/qsim模組參數，或transitSchedule與network的連接性問題。本報告提供系統性診斷流程和具體修復方案。

## 最可能的根本原因及診斷順序

根據MATSim社群中類似問題的診斷經驗，**約90%的「所有代理人都用walk而非PT」問題源於以下三大配置錯誤**。建議按此順序檢查：

### 優先診斷：Network link modes配置（最常見原因）

**問題症狀**：網路連結預設只有modes="car"，但transit schedule指定transportMode="metro"或"bus"等，導致PT車輛無法在網路上路由。

這是**最常見的錯誤**。當您從OpenStreetMap轉換網路或手動建立network.xml時，如果沒有明確為PT專用或共用的links添加適當的transport modes，所有links會預設為modes="car"。但transitSchedule.xml中的transit routes需要transportMode（如"train"、"metro"、"bus"），這些modes必須存在於route經過的每一條link上。

**診斷方法**：
1. 打開network.xml，隨機檢查幾條links的modes屬性
2. 檢查您的transitSchedule.xml中每條transitRoute的`<transportMode>`標籤
3. 確認transitSchedule中使用的所有transport modes都出現在相應network links的modes屬性中

**典型錯誤範例**：
```xml
<!-- network.xml -->
<link id="101" from="node1" to="node2" modes="car"/>
<!-- 問題：缺少metro mode -->

<!-- transitSchedule.xml -->
<transitRoute id="green_line_route">
  <transportMode>metro</transportMode>
  <!-- PT車輛無法在只有car mode的link上行駛 -->
</transitRoute>
```

**正確配置**：
```xml
<!-- 捷運專用links -->
<link id="metro_101" modes="metro"/>

<!-- 捷運與汽車共用links（地面段） -->
<link id="mixed_201" modes="car,metro"/>

<!-- 多種PT模式共用 -->
<link id="station_link" modes="metro,bus,walk"/>
```

**快速修復方法**：使用Java程式碼批次添加PT modes到所有相關links：
```java
for (Link link : network.getLinks().values()) {
    Set<String> modes = new HashSet<>(link.getAllowedModes());
    // 為所有car links添加metro mode（假設捷運可在所有道路上行駛）
    if (modes.contains("car")) {
        modes.add("metro");
        link.setAllowedModes(modes);
    }
}
new NetworkWriter(network).write("network_with_metro.xml");
```

### 第二優先：Config.xml的qsim mainMode參數錯誤

**問題症狀**：qsim.mainMode包含"pt"（乘客模式）而非"metro"、"bus"等車輛模式，導致模擬器無法正確處理PT車輛。

這是一個**極易混淆的配置陷阱**。MATSim區分「網路模式」（network modes，車輛實際在網路上行駛的模式）和「乘客模式」（passenger modes，代理人在plans中選擇的模式）。qsim的mainMode參數指的是network modes，**不應包含"pt"**。

**錯誤配置範例**：
```xml
<module name="qsim">
  <param name="mainMode" value="car,pt"/>
  <!-- 錯誤："pt"是乘客模式，不是車輛模式 -->
</module>
```

**正確配置範例**（針對台北捷運場景）：
```xml
<module name="qsim">
  <param name="mainMode" value="car,metro,bus"/>
  <!-- 使用實際的車輛transport modes -->
  <param name="startTime" value="00:00:00"/>
  <param name="endTime" value="30:00:00"/>
  <!-- 重要：設定足夠長的endTime避免代理人卡住 -->
</module>

<module name="transit">
  <param name="useTransit" value="true"/>
  <!-- 必須啟用transit -->
  <param name="transitModes" value="pt"/>
  <!-- 乘客模式設定為"pt" -->
  <param name="transitScheduleFile" value="transitSchedule.xml"/>
  <param name="vehiclesFile" value="transitVehicles.xml"/>
  <param name="routingAlgorithmType" value="SwissRailRaptor"/>
</module>
```

**關鍵原則**：
- **qsim.mainMode**：使用vehicle modes（metro, bus, train, tram）
- **transit.transitModes**：使用passenger mode（"pt"或特定的"rail", "road"等）
- 這兩個參數的值**絕對不應該包含相同的字串**
- **絕對不要在逗號後加空格**："car,metro"正確，"car, metro"會導致解析錯誤

### 第三優先：Transit schedule與network的連接性問題

**問題症狀**：PT stops的linkRefId指向不存在的links，或指向的links不在transit route的路徑上，導致代理人無法登上車輛。

**每個transitStopFacility必須滿足三個條件**：
1. linkRefId必須指向network.xml中實際存在的link
2. 該link必須在transit route的完整network route路徑中
3. 該link必須具有與transit route的transportMode相容的mode

**診斷工具**：執行TransitScheduleValidator
```bash
java -cp matsim-VERSION.jar \
  org.matsim.pt.utils.TransitScheduleValidator \
  transitSchedule.xml \
  network.xml
```

**常見驗證錯誤訊息**：
- "Stop [ID] cannot be reached along network route" → stop的link不在route路徑上
- "Transit line [ID], route [ID] has no network route" → 缺少`<route>`區段
- "inconsistent network route between link A and B" → links之間沒有連接（不共享節點）

## 系統化診斷流程

按照這個順序逐步診斷，可以最快找到問題：

### 步驟1：執行Transit Schedule Validator（必做，5分鐘）

```bash
java -cp matsim-VERSION.jar \
  org.matsim.pt.utils.TransitScheduleValidator \
  transitSchedule.xml network.xml
```

**期望結果**："Schedule appears valid!"

### 步驟2：檢查config.xml關鍵參數（必做，10分鐘）

創建檢查清單並逐項確認：

- [ ] `transit.useTransit = "true"`
- [ ] `transit.transitScheduleFile` 路徑正確
- [ ] `transit.vehiclesFile` 路徑正確
- [ ] `qsim.mainMode` 包含vehicle modes（metro/bus），**不包含"pt"**
- [ ] `qsim.mainMode` 值中沒有空格（"car,metro"而非"car, metro"）
- [ ] `transit.transitModes = "pt"` 或其他passenger mode
- [ ] `qsim.endTime = "30:00:00"` 或更高
- [ ] PT mode有scoring parameters（在planCalcScore中）
- [ ] walk mode有scoring parameters（在planCalcScore中）
- [ ] walk mode有teleportedModeParameters（在planscalcroute中）

### 步驟3：檢查network links的modes屬性（15分鐘）

**方法A：程式化檢查**（推薦）
```java
// 檢查network中有哪些modes
Set<String> allModesInNetwork = new HashSet<>();
for (Link link : network.getLinks().values()) {
    allModesInNetwork.addAll(link.getAllowedModes());
}
System.out.println("Network contains modes: " + allModesInNetwork);
// 應該看到: [car, metro, walk] 或類似

// 檢查transit schedule中的modes是否在network中
Set<String> modesInSchedule = new HashSet<>();
for (TransitLine line : schedule.getTransitLines().values()) {
    for (TransitRoute route : line.getRoutes().values()) {
        modesInSchedule.add(route.getTransportMode());
    }
}
System.out.println("Schedule uses modes: " + modesInSchedule);
```

## 快速修復方案總結

如果您需要緊急讓PT運作，按這個順序修復（預計1-2小時）：

### 立即行動（30分鐘）

**1. 修改config.xml**：
```xml
<module name="transit">
  <param name="useTransit" value="true"/>
  <param name="transitScheduleFile" value="transitSchedule.xml"/>
  <param name="vehiclesFile" value="transitVehicles.xml"/>
  <param name="transitModes" value="pt"/>
  <param name="routingAlgorithmType" value="SwissRailRaptor"/>
</module>

<module name="qsim">
  <param name="mainMode" value="car,metro"/>
  <!-- 移除"pt"，使用"metro" -->
  <param name="endTime" value="30:00:00"/>
</module>

<module name="planCalcScore">
  <parameterset type="scoringParameters">
    <param name="waitingPt" value="-6.0"/>
    <param name="utilityOfLineSwitch" value="-1.0"/>
    
    <parameterset type="modeParams">
      <param name="mode" value="pt"/>
      <param name="marginalUtilityOfTraveling_util_hr" value="-6.0"/>
    </parameterset>
    
    <parameterset type="modeParams">
      <param name="mode" value="walk"/>
      <param name="marginalUtilityOfTraveling_util_hr" value="-12.0"/>
    </parameterset>
  </parameterset>
</module>

<module name="planscalcroute">
  <parameterset type="teleportedModeParameters">
    <param name="mode" value="walk"/>
    <param name="teleportedModeSpeed" value="0.833"/>
    <param name="beelineDistanceFactor" value="1.3"/>
  </parameterset>
</module>
```

**2. 為network添加metro mode**：
```java
Network network = scenario.getNetwork();
for (Link link : network.getLinks().values()) {
    Set<String> modes = new HashSet<>(link.getAllowedModes());
    modes.add("metro");
    link.setAllowedModes(modes);
}
new NetworkWriter(network).write("network_with_metro.xml");
```

**3. 執行validator**：
```bash
java -cp matsim.jar org.matsim.pt.utils.TransitScheduleValidator \
  transitSchedule.xml network_with_metro.xml
```

## 結論與行動建議

您的問題「從第0次到第5次迭代，118個PT Transfer Agent全部使用walk模式」是典型的MATSim PT配置錯誤，**不是程式碼bug**。根據大量類似案例的診斷經驗，問題幾乎肯定是以下三者之一：

1. **Network links缺少PT transport modes**（70%機率）
2. **Config.xml的qsim.mainMode包含"pt"或useTransit=false**（20%機率）  
3. **TransitSchedule與network連接性問題**（10%機率）

### 立即行動清單（按優先順序）

**第一步（最關鍵）**：執行TransitScheduleValidator
```bash
java -cp matsim.jar org.matsim.pt.utils.TransitScheduleValidator \
  transitSchedule.xml network.xml
```
如果有ERROR，先修復這些再繼續。

**第二步**：檢查config.xml
- `transit.useTransit = "true"` ✓
- `qsim.mainMode = "car,metro"`（不含"pt"）✓
- 無空格在參數值中 ✓

**第三步**：為network links添加metro mode
使用提供的Java程式碼批次添加。

**第四步**：重新運行並檢查
- 查看log中的mode statistics
- 應該看到pt share > 0
- 檢查是否有TransitDriverStarts events

正確配置後，您應該看到：
```
INFO ModeStatsControlerListener: mode share of mode pt = 0.35
INFO ModeStatsControlerListener: mode share of mode walk = 0.25
INFO ModeStatsControlerListener: mode share of mode car = 0.40
```

祝調試順利！依照本指南的系統化流程，您應該能在1-2小時內找到並修復根本原因。